#include <stdint.h>

#include "sw/device/lib/base/macros.h"

#ifdef OT_COVERAGE_INSTRUMENTED

OT_SECTION("__llvm_prf_cnts_asm")
uint8_t _prf_cnts_asm[96] = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,

  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,

  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
};

OT_NO_COVERAGE
uint32_t coverage_backup_asm_counters(uint32_t offset) {
  uint32_t packed_byte = 0;
  for (uint8_t k = 0; k < 32; ++k) {
    uint32_t bit = _prf_cnts_asm[offset + k] == 0 ? 1 : 0;
    packed_byte |= (bit << k);
  }
  return packed_byte;
}

OT_NO_COVERAGE
void coverage_restore_asm_counters(uint32_t a, uint32_t b) {
  for (int i=0; i<32; i++) {
    if ((a >> i) & 1) {
      _prf_cnts_asm[i] = 0;
    }
  }
  for (int i=0; i<32; i++) {
    if ((b >> i) & 1) {
      _prf_cnts_asm[i+32] = 0;
    }
  }
}

#endif
